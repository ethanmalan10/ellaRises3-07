<main class="main-content">
  <section class="container" style="margin-top:1.25rem;">
    <div class="card" style="padding:28px; border-radius:18px;">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap;">
        <div>
          <h1 style="margin:0; font-family: var(--font-serif);">Manage Milestones</h1>
          <p style="margin:6px 0 0 0; color:var(--charcoal); opacity:.8;">
            Add milestones to the catalog and assign them to participants.
          </p>
        </div>
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <a href="/admin/milestones/assignments" class="btn-cream" style="padding:10px 16px; border-radius:10px; text-decoration:none;">
            Manage and View Participant Milestones
          </a>
          <a href="/admin/milestones/add" class="btn-login-home" style="padding:10px 16px; border-radius:10px; text-decoration:none;">
            + Add Milestone
          </a>
        </div>
      </div>

      <% if (message) { %>
        <div style="margin-top:16px; padding:10px 12px; border-radius:10px; background:#e8f5e9; color:#1b5e20;">
          <%= message %>
        </div>
      <% } %>
      <% if (error) { %>
        <div style="margin-top:16px; padding:10px 12px; border-radius:10px; background:#ffebee; color:#b71c1c;">
          <%= error %>
        </div>
      <% } %>
    </div>
  </section>

  <!-- Catalog -->
  <section class="container" style="margin-top:1rem;">
    <div class="card" style="padding:20px; border-radius:18px;">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
        <h2 style="margin:0;">Milestone Catalog</h2>
        <a href="/admin/milestones/add" style="text-decoration:none; font-weight:600; color:var(--charcoal);">Add</a>
      </div>

      <% const cPag = catalogPagination || { page:1, pageSize:(catalog||[]).length, total:(catalog||[]).length, totalPages:1, hasPrev:false, hasNext:false }; %>
      <% if (!catalog || catalog.length === 0) { %>
        <p style="margin:0;">No milestones in the catalog yet.</p>
      <% } else { %>
        <div style="margin:0 0 10px 0; display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
          <form method="GET" style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin:0;">
            <input id="catalog-search" name="catalogSearch" value="<%= catalogSearch || '' %>" type="search" placeholder="Quick search milestones..." style="width:100%; max-width:320px; padding:10px 12px; border-radius:10px; border:1px solid #d1d5db;">
            <button type="submit" class="btn-cream" style="padding:8px 12px; border-radius:10px;">Search</button>
            <a href="/admin/milestones" class="btn-outline" style="padding:8px 12px; border-radius:10px; text-decoration:none;">Clear</a>
          </form>
          <form method="GET" style="display:flex; align-items:center; gap:8px; flex-wrap:wrap; margin:0;">
            <input type="hidden" name="catalogSearch" value="<%= catalogSearch || '' %>">
            <div style="color:#4b5563;">Showing <%= Math.min((cPag.page - 1) * cPag.pageSize + 1, cPag.total || 0) %>-<%= Math.min(cPag.page * cPag.pageSize, cPag.total || 0) %> of <%= cPag.total || 0 %></div>
            <input type="hidden" name="page" value="<%= cPag.page %>">
            <label style="display:flex; align-items:center; gap:6px;">
              <span style="color:#4b5563;">Per page</span>
              <select name="pageSize" onchange="this.form.page.value=1; this.form.submit();" style="padding:8px 10px; border-radius:10px; border:1px solid #d1d5db;">
                <% (catalogPageSizeOptions || [10,25,50]).forEach(size => { %>
                  <option value="<%= size %>" <%= size === cPag.pageSize ? 'selected' : '' %>><%= size %></option>
                <% }) %>
              </select>
            </label>
            <div style="display:flex; gap:6px; flex-wrap:wrap;">
              <button type="submit" class="btn-cream" style="padding:8px 12px; border-radius:10px;" onclick="this.form.page.value=1;" <%= cPag.page > 1 ? '' : 'disabled' %>>&laquo; Start</button>
              <button type="submit" class="btn-cream" style="padding:8px 12px; border-radius:10px;" onclick="this.form.page.value=<%= Math.max(1, cPag.page - 1) %>;" <%= cPag.hasPrev ? '' : 'disabled' %>>&lsaquo; Back</button>
              <button type="submit" class="btn-cream" style="padding:8px 12px; border-radius:10px;" onclick="this.form.page.value=<%= Math.min(cPag.totalPages, cPag.page + 1) %>;" <%= cPag.hasNext ? '' : 'disabled' %>>Next &rsaquo;</button>
              <button type="submit" class="btn-cream" style="padding:8px 12px; border-radius:10px;" onclick="this.form.page.value=<%= cPag.totalPages %>;" <%= cPag.page < cPag.totalPages ? '' : 'disabled' %>>End &raquo;</button>
            </div>
          </form>
        </div>
        <div style="overflow-x:auto;">
          <table style="width:100%; border-collapse:collapse;">
            <thead>
              <tr style="text-align:left; border-bottom:1px solid #ddd;">
                <th style="padding:8px;">Title</th>
                <th style="padding:8px; width:110px;">Assignments</th>
                <th style="padding:8px; width:140px;">Actions</th>
              </tr>
            </thead>
            <tbody>
              <% catalog.forEach(c => { %>
                <tr class="catalog-row" data-search="<%= (c.title || '').toLowerCase() %>" style="border-bottom:1px solid #f0f0f0;">
                  <td style="padding:8px;"><%= c.title %></td>
                  <td style="padding:8px; color:#666;">
                    <%= (milestoneCounts && typeof milestoneCounts[c.id] !== 'undefined') ? milestoneCounts[c.id] : 0 %>
                  </td>
                  <td style="padding:8px; display:flex; gap:8px;">
                    <a href="/admin/milestones/<%= c.id %>/edit" style="text-decoration:none; color:#1565c0;">Edit</a>
                    <a href="/admin/milestones/<%= c.id %>/delete" style="text-decoration:none; color:#b71c1c;">Delete</a>
                  </td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        </div>
      <% } %>
    </div>
  </section>

</main>

<script>
  (() => {
    const input = document.getElementById('catalog-search');
    const rows = Array.from(document.querySelectorAll('.catalog-row'));
    if (!input || rows.length === 0) return;
    const run = () => {
      const q = (input.value || '').trim().toLowerCase();
      rows.forEach(r => {
        const match = !q || (r.dataset.search || '').includes(q);
        r.style.display = match ? '' : 'none';
      });
    };
    input.addEventListener('input', run);
  })();
</script>
