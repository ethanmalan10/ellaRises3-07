<main class="container main-content" style="max-width:920px; margin-top:2.5rem;">
  <div class="card" style="padding:32px; border-radius:14px;">
    <h2 style="margin:0 0 1rem 0; font-family:var(--font-serif); color:var(--charcoal);">Add Participant</h2>
    <p style="margin:0 0 1rem 0; color:#4b5563;">Create a participant and optionally a linked user.</p>

    <% if (error) { %>
      <div style="background:#ffe1e1; border:1px solid #dd9a9a; color:#7a2e2e; padding:12px 16px; border-radius:10px; margin-bottom:1rem;">
        <%= error %>
      </div>
    <% } %>

    <form method="POST" action="/participants/new" novalidate>
      <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(220px,1fr)); gap:12px; margin-bottom:1rem;">
        <div>
          <label style="font-weight:600; display:block; margin-bottom:.35rem;">First Name</label>
          <input name="participantfirstname" type="text" value="<%= participant.participantfirstname || '' %>" required style="width:100%; padding:12px; border-radius:10px;">
        </div>
        <div>
          <label style="font-weight:600; display:block; margin-bottom:.35rem;">Last Name</label>
          <input name="participantlastname" type="text" value="<%= participant.participantlastname || '' %>" required style="width:100%; padding:12px; border-radius:10px;">
        </div>
      </div>

      <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(220px,1fr)); gap:12px; margin-bottom:1rem;">
        <div>
          <label style="font-weight:600; display:block; margin-bottom:.35rem;">Email</label>
          <input name="participantemail" type="email" value="<%= participant.participantemail || '' %>" required style="width:100%; padding:12px; border-radius:10px;">
        </div>
        <div>
          <label style="font-weight:600; display:block; margin-bottom:.35rem;">DOB</label>
          <input name="participantdob" type="date" value="<%= participant.participantdob || '' %>" style="width:100%; padding:12px; border-radius:10px;">
        </div>
      </div>

      <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(220px,1fr)); gap:12px; margin-bottom:1rem;">
        <div>
          <label style="font-weight:600; display:block; margin-bottom:.35rem;">Phone</label>
          <input name="participantphone" type="text" inputmode="tel" pattern="\\d*" value="<%= participant.participantphone || '' %>" required style="width:100%; padding:12px; border-radius:10px;" oninput="digitsOnly(this)">
        </div>
        <div>
          <label style="font-weight:600; display:block; margin-bottom:.35rem;">City</label>
          <input name="participantcity" type="text" value="<%= participant.participantcity || '' %>" style="width:100%; padding:12px; border-radius:10px;">
        </div>
      </div>

      <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(220px,1fr)); gap:12px; margin-bottom:1rem;">
        <div>
          <label style="font-weight:600; display:block; margin-bottom:.35rem;">State</label>
          <select name="participantstate" style="width:100%; padding:12px; border-radius:10px;">
            <option value="">Select</option>
            <% const states = ['AL','AK','AZ','AR','CA','CO','CT','DE','FL','GA','HI','ID','IL','IN','IA','KS','KY','LA','ME','MD','MA','MI','MN','MS','MO','MT','NE','NV','NH','NJ','NM','NY','NC','ND','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VT','VA','WA','WV','WI','WY','Other']; %>
            <% states.forEach(st => { %>
              <option value="<%= st %>" <%= participant.participantstate === st ? 'selected' : '' %>><%= st %></option>
            <% }) %>
          </select>
        </div>
        <div>
          <label style="font-weight:600; display:block; margin-bottom:.35rem;">Zip</label>
          <input name="participantzip" type="text" inputmode="numeric" pattern="\\d*" value="<%= participant.participantzip || '' %>" style="width:100%; padding:12px; border-radius:10px;" oninput="digitsOnly(this)">
        </div>
      </div>

      <div style="margin-bottom:1rem;">
        <label style="font-weight:600; display:block; margin-bottom:.35rem;">Affiliation Type</label>
        <div style="display:flex; gap:18px;">
          <label style="display:flex; align-items:center; gap:6px;">
            <input type="radio" name="participantaffiliationtype" value="School" <%= participant.participantaffiliationtype === 'School' ? 'checked' : '' %>> School
          </label>
          <label style="display:flex; align-items:center; gap:6px;">
            <input type="radio" name="participantaffiliationtype" value="Employer" <%= participant.participantaffiliationtype === 'Employer' ? 'checked' : '' %>> Employer
          </label>
        </div>
      </div>
      <div style="margin-bottom:1rem;">
        <label style="font-weight:600; display:block; margin-bottom:.35rem;">Affiliation Name</label>
        <input name="participantaffiliationname" type="text" value="<%= participant.participantaffiliationname || '' %>" style="width:100%; padding:12px; border-radius:10px;">
      </div>

      <div style="margin-bottom:1rem;">
        <label style="font-weight:600; display:block; margin-bottom:.35rem;">Field of Interest</label>
        <input name="participantfieldofinterest" type="text" value="<%= participant.participantfieldofinterest || '' %>" style="width:100%; padding:12px; border-radius:10px;">
      </div>

      <div style="margin-bottom:1rem;">
        <label style="font-weight:600; display:block; margin-bottom:.35rem;">Milestones</label>
        <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(220px,1fr)); gap:8px;">
          <% catalog.forEach(m => { %>
            <label style="display:flex; align-items:center; gap:6px;">
              <input type="checkbox" name="milestones" value="<%= m.id %>"> <%= m.title %>
            </label>
          <% }) %>
        </div>
      </div>

      <div style="margin-bottom:1rem; padding:14px; border:1px solid #e5e7eb; border-radius:10px;">
        <label style="font-weight:600; display:block; margin-bottom:.35rem;">Create User Account?</label>
        <label style="display:flex; align-items:center; gap:6px; margin-bottom:8px;">
          <input type="checkbox" name="createUser" value="true"> Yes, create login
        </label>
        <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(220px,1fr)); gap:12px;">
          <div>
            <label style="font-weight:600; display:block; margin-bottom:.35rem;">Username (email)</label>
            <input name="username" type="email" value="<%= participant.username || '' %>" style="width:100%; padding:12px; border-radius:10px;">
          </div>
          <div>
            <label style="font-weight:600; display:block; margin-bottom:.35rem;">Password</label>
            <input name="password" type="text" value="" style="width:100%; padding:12px; border-radius:10px;">
          </div>
          <div>
            <label style="font-weight:600; display:block; margin-bottom:.35rem;">Role</label>
            <% const levelVal = ((participant.userLevel || participant.level || 'u').toString().toLowerCase()); %>
            <select name="userLevel" style="width:100%; padding:12px; border-radius:10px;">
              <option value="u" <%= levelVal === 'u' ? 'selected' : '' %>>Common User</option>
              <option value="m" <%= levelVal === 'm' ? 'selected' : '' %>>Manager</option>
            </select>
          </div>
        </div>
      </div>

      <div style="display:flex; gap:12px; align-items:center; margin-top:1.2rem;">
        <button type="submit" class="btn-gradient" style="padding:12px 18px; border-radius:12px;">Save</button>
        <button type="button" class="btn-cream" style="padding:10px 16px; border-radius:10px;" onclick="window.history.back();">Back</button>
        <a href="/participants" class="btn-cream" style="padding:10px 16px; border-radius:10px; text-decoration:none;">Cancel</a>
      </div>
    </form>
  </div>
</main>

<script>
  function digitsOnly(el) {
    if (!el) return;
    el.value = (el.value || '').replace(/\\D/g, '');
  }
</script>
