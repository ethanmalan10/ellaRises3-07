<main class="container main-content" style="max-width:1000px; margin-top:2.5rem;">
  <% function calcAge(d){ if(!d) return '?'; const dob=new Date(d); if(Number.isNaN(dob)) return '?'; const now=new Date(); let age=now.getFullYear()-dob.getFullYear(); const m=now.getMonth()-dob.getMonth(); if(m<0||(m===0&&now.getDate()<dob.getDate())) age--; return age; } %>
  <% const pag = pagination || { page:1, pageSize: participants ? participants.length : 50, total: participants ? participants.length : 0, totalPages:1, hasPrev:false, hasNext:false }; %>

  <header style="display:flex; justify-content:space-between; align-items:center; gap:1rem; margin-bottom:1.25rem; flex-wrap:wrap;">
    <div>
      <h1 style="margin:0; font-family:var(--font-serif); color:var(--charcoal);">All Participants</h1>
      <p style="margin:.3rem 0 0 0; color:#4b5563;">Manage participants and linked users with attendance, survey, and milestone stats.</p>
    </div>
    <div style="display:flex; gap:10px; flex-wrap:wrap;">
      <a href="/participants/new" class="btn-login-home" style="padding:10px 16px; border-radius:10px; text-decoration:none; box-shadow:0 6px 14px rgba(0,0,0,0.08);">Add Participant</a>
      <a href="/" class="btn-cream" style="padding:10px 14px; border-radius:10px; text-decoration:none;">Back to Home</a>
      <a href="/participants/stats" class="btn-cream" style="padding:10px 14px; border-radius:10px; text-decoration:none;">Participant Statistics</a>
    </div>
  </header>

  <% if (!participants || participants.length === 0) { %>
    <p style="color:#6b7280;">No participants found.</p>
  <% } else { %>
    <form id="participant-filters" action="/participants" method="GET" style="margin:6px 0 12px 0; background:#fbeee8; padding:14px; border-radius:16px; border:1px solid #eadfd5; display:flex; flex-direction:column; gap:10px;">
      <input type="hidden" name="page" value="1">
      <input type="hidden" name="pageSize" value="<%= pag.pageSize %>">

      <!-- Row 1: search + actions -->
      <div style="display:flex; gap:10px; align-items:center;">
        <label for="participant-search" class="sr-only">Search participants</label>
        <input id="participant-search" name="q" type="text" placeholder="Quick search participants..." value="<%= (typeof filters !== 'undefined' && filters.q) ? filters.q : '' %>" style="flex:1; min-width:260px; padding:10px 12px; border:1px solid #d1d5db; border-radius:10px;">
        <button id="participant-search-btn" type="submit" class="btn-cream" style="padding:10px 14px; border-radius:10px; min-width:110px;">Search</button>
        <a href="/participants" class="btn-outline" style="padding:10px 14px; border-radius:10px; text-decoration:none; min-width:90px; text-align:center;">Clear</a>
        <button type="button" id="participants-export" class="btn-cream" style="padding:10px 14px; border-radius:10px; display:flex; align-items:center; gap:8px; min-width:130px; justify-content:center; border:none; cursor:pointer;">
          <span aria-hidden="true" style="display:inline-flex; width:18px; height:18px; align-items:center; justify-content:center;">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
              <path d="M12 3v12m0 0l-4-4m4 4l4-4M5 17h14v4H5v-4Z" stroke="var(--charcoal)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </span>
          <span>Export CSV</span>
        </button>
      </div>

      <!-- Row 2: sort, direction, milestone, actions -->
      <div style="display:flex; gap:10px; align-items:flex-end; flex-wrap:wrap;">
        <label style="display:flex; flex-direction:column; gap:4px; min-width:200px; flex:1;">
          <span style="color:#4b5563; font-size:.9rem;">Sort by</span>
          <select name="sortBy" style="padding:12px 12px; border-radius:10px; border:1px solid #d1d5db; width:100%;">
            <option value="name" <%= filters && filters.sortBy === 'name' ? 'selected' : '' %>>Name</option>
            <option value="events" <%= filters && filters.sortBy === 'events' ? 'selected' : '' %>>Events attended</option>
            <option value="surveys" <%= filters && filters.sortBy === 'surveys' ? 'selected' : '' %>>Surveys completed</option>
            <option value="milestones" <%= filters && filters.sortBy === 'milestones' ? 'selected' : '' %>>Milestones achieved</option>
          </select>
        </label>

        <label style="display:flex; flex-direction:column; gap:4px; min-width:200px; flex:1;">
          <span style="color:#4b5563; font-size:.9rem;">Direction</span>
          <select name="sortDir" style="padding:12px 12px; border-radius:10px; border:1px solid #d1d5db; width:100%;">
            <option value="desc" <%= (!filters || filters.sortDir !== 'asc') ? 'selected' : '' %>>High to low</option>
            <option value="asc" <%= filters && filters.sortDir === 'asc' ? 'selected' : '' %>>Low to high</option>
          </select>
        </label>

        <label style="display:flex; flex-direction:column; gap:4px; min-width:220px; flex:1;">
          <span style="color:#4b5563; font-size:.9rem;">Filter by milestone type</span>
          <select name="milestoneCatalogId" style="padding:12px 12px; border-radius:10px; border:1px solid #d1d5db; width:100%;">
            <option value="">All</option>
            <% (milestoneCatalog || []).forEach(m => { %>
              <option value="<%= m.milestonecatalogid %>" <%= filters && Number(filters.milestoneCatalogId) === Number(m.milestonecatalogid) ? 'selected' : '' %>><%= m.milestonetitle %></option>
            <% }) %>
          </select>
        </label>

        <div style="display:flex; gap:8px; margin-left:auto; align-items:center;">
          <button type="submit" class="btn-gradient" style="padding:10px 14px; border-radius:10px; font-weight:700; min-width:130px;">Apply Filters</button>
          <a href="/participants" class="btn-cream" style="padding:10px 14px; border-radius:10px; text-decoration:none; min-width:100px; text-align:center;">Reset</a>
        </div>
      </div>
    </form>

    <form id="participant-export-form" action="/participants/export" method="GET" style="display:none;"></form>

    <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap; margin-bottom:10px;">
      <div style="color:#4b5563;">Showing <%= Math.min((pag.page - 1) * pag.pageSize + 1, pag.total || 0) %>-<%= Math.min(pag.page * pag.pageSize, pag.total || 0) %> of <%= pag.total || 0 %></div>
      <form id="participants-page-form-top" method="GET" style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
        <input type="hidden" name="page" value="<%= pag.page %>">
        <input type="hidden" name="sortBy" value="<%= filters && filters.sortBy ? filters.sortBy : 'name' %>">
        <input type="hidden" name="sortDir" value="<%= filters && filters.sortDir ? filters.sortDir : 'desc' %>">
        <input type="hidden" name="eventTemplateId" value="<%= filters && filters.eventTemplateId ? filters.eventTemplateId : '' %>">
        <input type="hidden" name="eventTypeId" value="<%= filters && filters.eventTypeId ? filters.eventTypeId : '' %>">
        <input type="hidden" name="milestoneCatalogId" value="<%= filters && filters.milestoneCatalogId ? filters.milestoneCatalogId : '' %>">
        <input type="hidden" name="q" value="<%= filters && filters.q ? filters.q : '' %>">
        <label style="display:flex; align-items:center; gap:6px;">
          <span style="color:#4b5563;">Per page</span>
          <select name="pageSize" onchange="this.form.page.value=1; this.form.submit();" style="padding:8px 10px; border-radius:10px; border:1px solid #d1d5db;">
            <% (pageSizeOptions || [25,50,75,100]).forEach(size => { %>
              <option value="<%= size %>" <%= size === pag.pageSize ? 'selected' : '' %>><%= size %></option>
            <% }) %>
          </select>
        </label>
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <button type="submit" class="btn-cream" style="padding:8px 12px; border-radius:10px;" <%= pag.page > 1 ? '' : 'disabled' %> onclick="this.form.page.value=1;"><< Start</button>
          <button type="submit" class="btn-cream" style="padding:8px 12px; border-radius:10px;" <%= pag.hasPrev ? '' : 'disabled' %> onclick="this.form.page.value=<%= Math.max(1, pag.page - 1) %>;">&lt; Back</button>
          <button type="submit" class="btn-cream" style="padding:8px 12px; border-radius:10px;" <%= pag.hasNext ? '' : 'disabled' %> onclick="this.form.page.value=<%= Math.min(pag.totalPages, pag.page + 1) %>;">Next &gt;</button>
          <button type="submit" class="btn-cream" style="padding:8px 12px; border-radius:10px;" <%= pag.page < pag.totalPages ? '' : 'disabled' %> onclick="this.form.page.value=<%= pag.totalPages %>;">End >></button>
        </div>
      </form>
    </div>

    <div class="card" style="padding:16px; border-radius:12px; border:1px solid #e5e7eb;">
      <table id="participants-table" style="width:100%; border-collapse:collapse; font-size:0.98rem;">
        <caption style="text-align:left; padding:10px; font-weight:600;">All participants</caption>
        <thead>
          <tr style="text-align:left; border-bottom:1px solid #e5e7eb;">
            <th scope="col" style="padding:8px;">Name</th>
            <th scope="col" style="padding:8px;">Age</th>
            <th scope="col" style="padding:8px;">City</th>
            <th scope="col" style="padding:8px; text-align:center;">Events</th>
            <th scope="col" style="padding:8px; text-align:center;">Surveys</th>
            <th scope="col" style="padding:8px; text-align:center;">Milestones</th>
            <th scope="col" style="padding:8px;">User?</th>
            <th scope="col" style="padding:8px;">Actions</th>
          </tr>
        </thead>
        <tbody>
          <% participants.forEach(p => { 
               const searchBlob = [
                 p.participantfirstname || '',
                 p.participantlastname || '',
                 p.participantemail || '',
                 p.participantcity || '',
                 p.participantstate || ''
               ].join(' ').toLowerCase();
          %>
            <tr class="participant-row" data-search="<%= searchBlob %>" style="border-bottom:1px solid #f3f4f6;">
              <td style="padding:8px;"><%= [p.participantfirstname, p.participantlastname].filter(Boolean).join(' ') || '?' %></td>
              <td style="padding:8px;"><%= calcAge(p.participantdob) %></td>
              <td style="padding:8px;"><%= p.participantcity || '?' %></td>
              <td style="padding:8px; text-align:center; font-weight:600;"><%= p.events_attended || 0 %></td>
              <td style="padding:8px; text-align:center; font-weight:600;"><%= p.surveys_completed || 0 %></td>
              <td style="padding:8px; text-align:center; font-weight:600;"><%= p.milestones_completed || 0 %></td>
              <td style="padding:8px;"><%= p.username ? 'Yes' : 'No' %></td>
              <td style="padding:8px; display:flex; gap:6px; flex-wrap:wrap;">
                <a href="/participants/<%= p.participantid %>" class="btn-cream" style="padding:8px 12px; border-radius:8px; text-decoration:none;">View</a>
                <a href="/participants/<%= p.participantid %>/edit" class="btn-cream" style="padding:8px 12px; border-radius:8px; text-decoration:none;">Edit</a>
                <form method="POST" action="/participants/<%= p.participantid %>/delete" onsubmit="return confirm('Delete this participant?');">
                  <button type="submit" class="btn-outline" style="padding:8px 12px; border-radius:8px; border:1px solid #dc2626; color:#dc2626;">Delete</button>
                </form>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>

    <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap; margin-top:10px;">
      <div style="color:#4b5563;">Showing <%= Math.min((pag.page - 1) * pag.pageSize + 1, pag.total || 0) %>-<%= Math.min(pag.page * pag.pageSize, pag.total || 0) %> of <%= pag.total || 0 %></div>
      <form id="participants-page-form" method="GET" style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
        <input type="hidden" name="page" value="<%= pag.page %>">
        <input type="hidden" name="sortBy" value="<%= filters && filters.sortBy ? filters.sortBy : 'name' %>">
        <input type="hidden" name="sortDir" value="<%= filters && filters.sortDir ? filters.sortDir : 'desc' %>">
        <input type="hidden" name="eventTemplateId" value="<%= filters && filters.eventTemplateId ? filters.eventTemplateId : '' %>">
        <input type="hidden" name="eventTypeId" value="<%= filters && filters.eventTypeId ? filters.eventTypeId : '' %>">
        <input type="hidden" name="milestoneCatalogId" value="<%= filters && filters.milestoneCatalogId ? filters.milestoneCatalogId : '' %>">
        <input type="hidden" name="q" value="<%= filters && filters.q ? filters.q : '' %>">
        <label style="display:flex; align-items:center; gap:6px;">
          <span style="color:#4b5563;">Per page</span>
          <select name="pageSize" onchange="this.form.page.value=1; this.form.submit();" style="padding:8px 10px; border-radius:10px; border:1px solid #d1d5db;">
            <% (pageSizeOptions || [25,50,75,100]).forEach(size => { %>
              <option value="<%= size %>" <%= size === pag.pageSize ? 'selected' : '' %>><%= size %></option>
            <% }) %>
          </select>
        </label>
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <button type="submit" class="btn-cream" style="padding:8px 12px; border-radius:10px;" <%= pag.page > 1 ? '' : 'disabled' %> onclick="this.form.page.value=1;"><< Start</button>
          <button type="submit" class="btn-cream" style="padding:8px 12px; border-radius:10px;" <%= pag.hasPrev ? '' : 'disabled' %> onclick="this.form.page.value=<%= Math.max(1, pag.page - 1) %>;">&lt; Back</button>
          <button type="submit" class="btn-cream" style="padding:8px 12px; border-radius:10px;" <%= pag.hasNext ? '' : 'disabled' %> onclick="this.form.page.value=<%= Math.min(pag.totalPages, pag.page + 1) %>;">Next &gt;</button>
          <button type="submit" class="btn-cream" style="padding:8px 12px; border-radius:10px;" <%= pag.page < pag.totalPages ? '' : 'disabled' %> onclick="this.form.page.value=<%= pag.totalPages %>;">End >></button>
        </div>
      </form>
    </div>
  <% } %>
</main>

<script>
  // Export participants with current filters
  (function(){
    const exportBtn = document.getElementById('participants-export');
    const form = document.getElementById('participant-filters');
    const exportForm = document.getElementById('participant-export-form');
    if (!exportBtn || !form || !exportForm) return;
    exportBtn.addEventListener('click', (e) => {
      e.preventDefault();
      exportForm.innerHTML = '';
      Array.from(form.elements).forEach(el => {
        if (!el.name) return;
        if (el.type === 'button' || el.type === 'submit') return;
        if (el.name === 'page' || el.name === 'pageSize') return; // export all
        const value = el.value;
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = el.name;
        input.value = value;
        exportForm.appendChild(input);
      });
      exportForm.submit();
    });
  })();

  (function(){
    const btn = document.createElement('button');
    btn.id = 'jump-to-top';
    btn.type = 'button';
    btn.textContent = 'Jump to Top';
    btn.style.cssText = 'position:fixed; right:20px; bottom:20px; padding:10px 14px; border-radius:10px; border:none; background:#2e2f2e; color:#fff; cursor:pointer; display:none; box-shadow:0 6px 18px rgba(0,0,0,0.18); z-index:999;';
    btn.addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));
    document.body.appendChild(btn);

    window.addEventListener('scroll', () => {
      btn.style.display = window.scrollY > 240 ? 'block' : 'none';
    });
  })();
</script>
