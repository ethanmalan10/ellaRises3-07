<main class="container main-content" style="max-width:1000px; margin-top:2.5rem;">
  <% function calcAge(d){ if(!d) return '—'; const dob=new Date(d); if(Number.isNaN(dob)) return '—'; const now=new Date(); let age=now.getFullYear()-dob.getFullYear(); const m=now.getMonth()-dob.getMonth(); if(m<0||(m===0&&now.getDate()<dob.getDate())) age--; return age; } %>

  <header style="display:flex; justify-content:space-between; align-items:center; gap:1rem; margin-bottom:1.25rem; flex-wrap:wrap;">
    <div>
      <h1 style="margin:0; font-family:var(--font-serif); color:var(--charcoal);">All Participants</h1>
      <p style="margin:.3rem 0 0 0; color:#4b5563;">Manage participants and linked users.</p>
    </div>
    <div style="display:flex; gap:10px; flex-wrap:wrap;">
      <a href="/participants/new" class="btn-gradient" style="padding:10px 14px; border-radius:10px; text-decoration:none;">Add Participant</a>
      <a href="/" class="btn-cream" style="padding:10px 14px; border-radius:10px; text-decoration:none;">Back to Home</a>
    </div>
  </header>

  <% if (!participants || participants.length === 0) { %>
    <p style="color:#6b7280;">No participants found.</p>
  <% } else { %>
    <div style="margin:6px 0 12px 0; display:flex; gap:8px; flex-wrap:wrap;">
      <input id="participant-search" type="text" placeholder="Quick search participants..." style="width:100%; max-width:320px; padding:10px 12px; border:1px solid #d1d5db; border-radius:10px;">
      <button id="participant-search-btn" class="btn-cream" style="padding:10px 14px; border-radius:10px;">Search</button>
      <button id="participant-clear-btn" class="btn-outline" style="padding:10px 14px; border-radius:10px;">Clear</button>
    </div>
    <div class="card" style="padding:16px; border-radius:12px; border:1px solid #e5e7eb;">
      <table id="participants-table" style="width:100%; border-collapse:collapse;">
        <thead>
          <tr style="text-align:left; border-bottom:1px solid #e5e7eb;">
            <th style="padding:8px;">Name</th>
            <th style="padding:8px;">Age</th>
            <th style="padding:8px;">City</th>
            <th style="padding:8px;">User?</th>
            <th style="padding:8px;">Actions</th>
          </tr>
        </thead>
        <tbody>
          <% participants.forEach(p => { %>
            <tr class="participant-row" style="border-bottom:1px solid #f3f4f6;">
              <td style="padding:8px;"><%= [p.participantfirstname, p.participantlastname].filter(Boolean).join(' ') || '—' %></td>
              <td style="padding:8px;"><%= calcAge(p.participantdob) %></td>
              <td style="padding:8px;"><%= p.participantcity || '—' %></td>
              <td style="padding:8px;"><%= p.username ? 'Yes' : 'No' %></td>
              <td style="padding:8px; display:flex; gap:6px; flex-wrap:wrap;">
                <a href="/participants/<%= p.participantid %>" class="btn-cream" style="padding:8px 12px; border-radius:8px; text-decoration:none;">View</a>
                <a href="/participants/<%= p.participantid %>/edit" class="btn-cream" style="padding:8px 12px; border-radius:8px; text-decoration:none;">Edit</a>
                <form method="POST" action="/participants/<%= p.participantid %>/delete" onsubmit="return confirm('Delete this participant?');">
                  <button type="submit" class="btn-outline" style="padding:8px 12px; border-radius:8px; border:1px solid #dc2626; color:#dc2626;">Delete</button>
                </form>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
  <% } %>
</main>

<script>
  (function(){
    const input = document.getElementById('participant-search');
    const btn = document.getElementById('participant-search-btn');
    const clearBtn = document.getElementById('participant-clear-btn');
    const rows = Array.from(document.querySelectorAll('#participants-table .participant-row'));
    if (!input || !btn || !clearBtn || rows.length === 0) return;

    const storageKey = 'participantSearch';
    const saved = sessionStorage.getItem(storageKey) || '';
    if (saved) input.value = saved;

    const runFilter = () => {
      const q = input.value.trim().toLowerCase();
      sessionStorage.setItem(storageKey, input.value.trim());
      rows.forEach(r => {
        const text = r.innerText.toLowerCase();
        r.style.display = q ? (text.includes(q) ? '' : 'none') : '';
      });
    };
    btn.addEventListener('click', (e) => { e.preventDefault(); runFilter(); });

    clearBtn.addEventListener('click', (e) => {
      e.preventDefault();
      input.value = '';
      sessionStorage.removeItem(storageKey);
      rows.forEach(r => r.style.display = '');
    });

    // Apply saved filter on load
    if (saved) runFilter();
  })();
</script>
