<!-- Manager Surveys List - view, search, filter, and edit submitted surveys -->
<section class="main-content">
  <% const pagBase = pagination || { page:1, pageSize:(surveys || []).length || 50, total:(surveys ? surveys.length : 0), totalPages:1, hasPrev:false, hasNext:false }; %>
  <% const computedTotalPages = pagBase.totalPages || Math.max(1, Math.ceil((pagBase.total || 0) / (pagBase.pageSize || 1))); %>
  <% const pag = { ...pagBase, totalPages: computedTotalPages }; %>
  <div class="card" style="padding: 24px; border-radius: 18px;">
    <h2 style="margin:0 0 8px 0; font-family: var(--font-serif);">Submitted Surveys</h2>
    <p style="margin:0 0 16px 0; color:var(--charcoal); opacity:0.8;">
      Hover items to see actions. Click through to edit or delete.
    </p>

    <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap; margin-bottom:12px;">
      <div style="color:#4b5563;">Showing <%= Math.min((pag.page - 1) * pag.pageSize + 1, pag.total || 0) %>–<%= Math.min(pag.page * pag.pageSize, pag.total || 0) %> of <%= pag.total || 0 %></div>
      <form method="GET" style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
        <input type="hidden" name="page" value="<%= pag.page %>">
        <label style="display:flex; align-items:center; gap:6px;">
          <span style="color:#4b5563;">Per page</span>
          <select name="pageSize" onchange="this.form.page.value=1; this.form.submit();" style="padding:8px 10px; border-radius:10px; border:1px solid #d1d5db;">
            <% (pageSizeOptions || [25,50,75,100]).forEach(size => { %>
              <option value="<%= size %>" <%= size === pag.pageSize ? 'selected' : '' %>><%= size %></option>
            <% }) %>
          </select>
        </label>
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <button type="submit" class="btn-cream" style="padding:8px 12px; border-radius:10px;" <%= pag.page > 1 ? '' : 'disabled' %> onclick="this.form.page.value=1;"><< Start</button>
          <button type="submit" class="btn-cream" style="padding:8px 12px; border-radius:10px;" <%= pag.hasPrev ? '' : 'disabled' %> onclick="this.form.page.value=<%= Math.max(1, pag.page - 1) %>;">&lt; Back</button>
          <button type="submit" class="btn-cream" style="padding:8px 12px; border-radius:10px;" <%= pag.hasNext ? '' : 'disabled' %> onclick="this.form.page.value=<%= Math.min(pag.totalPages, pag.page + 1) %>;">Next &gt;</button>
          <button type="submit" class="btn-cream" style="padding:8px 12px; border-radius:10px;" <%= pag.page < pag.totalPages ? '' : 'disabled' %> onclick="this.form.page.value=<%= pag.totalPages %>;">End >></button>
        </div>
      </form>
    </div>

    <!-- Filters -->
    <div style="display:flex; gap:12px; flex-wrap:wrap; margin-bottom:14px;">
      <input
        id="survey-search"
        type="search"
        placeholder="Search by event title..."
        style="flex:1 1 240px; padding:10px 12px; border-radius:10px; border:1px solid #ddd;"
      />
      <select
        id="survey-score-filter"
        style="flex:0 0 160px; padding:10px 12px; border-radius:10px; border:1px solid #ddd;"
      >
        <option value="all">All scores</option>
        <option value="5">5 stars</option>
        <option value="4">4 stars</option>
        <option value="3">3 stars</option>
        <option value="2">2 stars</option>
        <option value="1">1 star</option>
      </select>
    </div>

    <% if (surveys && surveys.length) { %>
      <div style="display:grid; gap:16px;">
        <% surveys.forEach(s => { 
             const avg = Number(((Number(s.satisfaction) + Number(s.usefulness) + Number(s.instructor) + Number(s.recommendation))/4).toFixed(1));
             const evLabelRaw = s.eventName || s.eventname || (s.eventoccurrenceid ? `Event #${s.eventoccurrenceid}` : 'Unknown event');
             const evLabel = evLabelRaw || 'Unknown event';
             const submittedAt = s.submittedAt || s.surveysubmissiondate;
             const displayName = (s.participantName && s.participantName.trim().length)
               ? s.participantName
               : ((s.userName && s.userName.trim().length)
                    ? s.userName
                    : ((s.userEmail && s.userEmail.trim().length)
                        ? s.userEmail
                        : 'Unknown participant'));
        %>
          <div 
            class="survey-card" 
            data-event="<%= (evLabel || '').toLowerCase() %>" 
            data-score="<%= avg %>" 
            style="border:1px solid #eee; border-radius:12px; padding:14px 16px; transition: box-shadow .2s; background:#fff;"
          >
            <div style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
              <div>
                <p style="margin:0; font-weight:700; color:var(--charcoal);"><%= displayName %></p>
                <p style="margin:0; color:var(--charcoal); opacity:0.7;">Event: <%= evLabel %></p>
                <% const submitted = submittedAt ? new Date(submittedAt) : null; %>
                <p style="margin:0; color:var(--charcoal); opacity:0.6;">Submitted: <%= submitted && !Number.isNaN(submitted.valueOf()) ? submitted.toLocaleDateString() : 'N/A' %></p>
              </div>
              <div>
                <% for (let i = 1; i <= 5; i++) { %>
                  <span style="color:<%= i <= Math.round(avg) ? '#f7b500' : '#d8d8d8' %>; font-size:1.1rem;">★</span>
                <% } %>
                <p style="margin:2px 0 0 0; text-align:right; font-weight:700; color:var(--charcoal);"><%= avg %>/5</p>
              </div>
            </div>
            <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
              <span style="background:#f7f7f7; padding:6px 10px; border-radius:10px; font-weight:600;">Sat: <%= s.satisfaction %></span>
              <span style="background:#f7f7f7; padding:6px 10px; border-radius:10px; font-weight:600;">Useful: <%= s.usefulness %></span>
              <span style="background:#f7f7f7; padding:6px 10px; border-radius:10px; font-weight:600;">Instructor: <%= s.instructor %></span>
              <span style="background:#f7f7f7; padding:6px 10px; border-radius:10px; font-weight:600;">Recommend: <%= s.recommendation %></span>
            </div>
            <% if (s.comments) { %>
              <p style="margin:10px 0 0 0; color:var(--charcoal); opacity:0.8;"><%= s.comments %></p>
            <% } %>
            <div style="display:flex; gap:10px; margin-top:12px; flex-wrap:wrap;">
              <a class="btn-login-home" style="padding:8px 12px; border-radius:10px;" href="/admin/surveys/<%= s.id %>/edit">Edit</a>
              <form class="survey-delete-form" action="/admin/surveys/<%= s.id %>/delete" method="POST" style="display:inline;">
                <button type="button" class="btn-login-home survey-delete-btn" data-id="<%= s.id %>" style="padding:8px 12px; border-radius:10px; background:#ffe1e1; color:#7a2e2e;">Delete</button>
              </form>
            </div>
          </div>
        <% }) %>
      </div>
      <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap; margin-top:16px;">
        <div style="color:#4b5563;">Showing <%= Math.min((pag.page - 1) * pag.pageSize + 1, pag.total || 0) %>–<%= Math.min(pag.page * pag.pageSize, pag.total || 0) %> of <%= pag.total || 0 %></div>
        <form method="GET" style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
          <input type="hidden" name="page" value="<%= pag.page %>">
          <label style="display:flex; align-items:center; gap:6px;">
            <span style="color:#4b5563;">Per page</span>
            <select name="pageSize" onchange="this.form.page.value=1; this.form.submit();" style="padding:8px 10px; border-radius:10px; border:1px solid #d1d5db;">
              <% (pageSizeOptions || [25,50,75,100]).forEach(size => { %>
                <option value="<%= size %>" <%= size === pag.pageSize ? 'selected' : '' %>><%= size %></option>
              <% }) %>
            </select>
          </label>
          <div style="display:flex; gap:8px; flex-wrap:wrap;">
            <button type="submit" class="btn-cream" style="padding:8px 12px; border-radius:10px;" <%= pag.page > 1 ? '' : 'disabled' %> onclick="this.form.page.value=1;"><< Start</button>
            <button type="submit" class="btn-cream" style="padding:8px 12px; border-radius:10px;" <%= pag.hasPrev ? '' : 'disabled' %> onclick="this.form.page.value=<%= Math.max(1, pag.page - 1) %>;">&lt; Back</button>
            <button type="submit" class="btn-cream" style="padding:8px 12px; border-radius:10px;" <%= pag.hasNext ? '' : 'disabled' %> onclick="this.form.page.value=<%= Math.min(pag.totalPages, pag.page + 1) %>;">Next &gt;</button>
            <button type="submit" class="btn-cream" style="padding:8px 12px; border-radius:10px;" <%= pag.page < pag.totalPages ? '' : 'disabled' %> onclick="this.form.page.value=<%= pag.totalPages %>;">End >></button>
          </div>
        </form>
      </div>
    <% } else { %>
      <p style="margin:0; color:var(--charcoal); opacity:0.7;">No surveys submitted yet.</p>
    <% } %>
  </div>
</section>

<script>
  (function() {
    const searchInput = document.getElementById('survey-search');
    const scoreFilter = document.getElementById('survey-score-filter');
    const cards = Array.from(document.querySelectorAll('.survey-card'));

    function applyFilters() {
      const term = (searchInput.value || '').trim().toLowerCase();
      const scoreVal = scoreFilter.value;

      cards.forEach(card => {
        const matchesTerm = card.dataset.event.includes(term);
        const score = Number(card.dataset.score || 0);
        const matchesScore =
          scoreVal === 'all' ||
          (scoreVal === '5' && Math.round(score) === 5) ||
          (scoreVal === '4' && Math.round(score) === 4) ||
          (scoreVal === '3' && Math.round(score) === 3) ||
          (scoreVal === '2' && Math.round(score) === 2) ||
          (scoreVal === '1' && Math.round(score) === 1);

        card.style.display = matchesTerm && matchesScore ? 'block' : 'none';
      });
    }

    searchInput?.addEventListener('input', applyFilters);
    scoreFilter?.addEventListener('change', applyFilters);
  })();

  (function(){
    const btn = document.createElement('button');
    btn.id = 'jump-to-top-surveys';
    btn.type = 'button';
    btn.textContent = 'Jump to Top';
    btn.style.cssText = 'position:fixed; right:20px; bottom:20px; padding:10px 14px; border-radius:10px; border:none; background:#2e2f2e; color:#fff; cursor:pointer; display:none; box-shadow:0 6px 18px rgba(0,0,0,0.18); z-index:999;';
    btn.addEventListener('click', () => window.scrollTo({ top: 0, behavior: "smooth" }));
    document.body.appendChild(btn);
    window.addEventListener('scroll', () => {
      btn.style.display = window.scrollY > 240 ? 'block' : 'none';
    });
  })();

  (function(){
    const deleteButtons = document.querySelectorAll('.survey-delete-btn');
    deleteButtons.forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        const form = btn.closest('form');
        if (!form) return;
        const confirmed = window.confirm('Are you sure you want to delete this survey response?');
        if (confirmed) form.submit();
      });
    });
  })();
</script>
