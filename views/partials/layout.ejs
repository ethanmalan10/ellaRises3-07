<%
  // Access the logged-in user (provided by index.js via res.locals.currentUser)
  const user = typeof currentUser !== 'undefined' ? currentUser : null;
  const isManager = user && (
    user.role === 'manager' ||
    user.role === 'admin' ||
    user.level === 'm' ||
    user.level === 'a' ||
    user.level === 'manager' ||
    user.level === 'admin'
  );
%>
<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Head partial (CSS, fonts, <meta>, etc.) -->
  <%- include('_head') %>
</head>

<body>
  <a class="skip-link" href="#main-content">Skip to main content</a>

  <!-- NAVBAR -->
  <nav class="navbar">

    <!-- Logo -->
    <a href="/" class="navbar-brand">
      <img src="/images/EllaRisesLogo.avif" alt="Ella Rises" class="logo-img">
    </a>

    <!-- Center Section: Main Links -->
    <div class="navbar-nav" style="margin-left: .25rem;">
      <a href="/donations" class="nav-link" style="background: var(--sage); color: #fff; padding:8px 14px; border-radius:12px;">ü§ç Donations</a>
      <% if (user) { %>
        <a href="/surveys"   class="nav-link">Surveys</a>
      <% } %>
      <a href="/events"    class="nav-link">Events</a>
    </div>

    <!-- Right Side -->
    <div class="navbar-nav" style="margin-left:auto; align-items:center; gap:10px;">
      <div class="dropdown" id="lang-dropdown" style="position:relative;">
        <button type="button" id="lang-toggle" class="nav-link nav-toggle notranslate" aria-haspopup="true" aria-expanded="false" aria-controls="lang-menu">Language</button>
        <div id="lang-menu" class="dropdown-content" style="right:0; min-width:140px;">
          <a href="#" class="lang-option" data-target="en">English</a>
          <a href="#" class="lang-option" data-target="es">Espa√±ol</a>
        </div>
      </div>
      <% if (!user) { %>
        <!-- Login / Register Dropdown -->
        <div class="dropdown">
          <button type="button" class="nav-link nav-toggle" aria-haspopup="true" aria-expanded="false" aria-controls="auth-menu">Login / Register</button>
          <div id="auth-menu" class="dropdown-content">
            <a href="/login">Login</a>
            <a href="/register">Create Account</a>
          </div>
        </div>

      <% } else { %>
        <!-- User Dropdown -->
        <div class="dropdown">
          <button type="button" class="nav-link nav-toggle" aria-haspopup="true" aria-expanded="false" aria-controls="account-menu">My Account</button>
          <div id="account-menu" class="dropdown-content">

            <!-- Always available -->
            <a href="/my-account">My Account</a>

            <!-- Manager/Admin Only -->
            <% if (isManager) { %>
              <a href="/participants">All Participants</a>
              <a href="/admin/users">All Users</a>
              <a href="/admin/milestones">Manage Milestones</a>
              <a href="/dashboard">Dashboard</a>
              <a href="/admin/surveys">View Surveys</a>
              <a href="/admin/donations">View Donations</a>
            <% } else { %>
              <!-- Regular users see milestones -->
              <a href="/milestones">Milestones</a>
            <% } %>

            <!-- Logout -->
            <a href="/logout">Logout</a>

          </div>
        </div>
      <% } %>

    </div>
  </nav>

  <main class="container" id="main-content">
    <%- body %>
  </main>

  <!-- Footer -->
  <footer class="footer">
    <p>&copy; 2025 Ella Rises. Empowering the rising generation of women.</p>
  </footer>

  <div id="google_translate_element" aria-hidden="true" style="display:none;"></div>
  <script src="/js/lang-toggle.js"></script>
  <script>
    (function () {
      const toggles = Array.from(document.querySelectorAll('.nav-toggle'));
      const dropdowns = toggles.map(btn => ({
        btn,
        menu: btn.parentElement.querySelector('.dropdown-content')
      }));

      const closeAll = (exceptBtn = null) => {
        dropdowns.forEach(({ btn, menu }) => {
          if (exceptBtn && btn === exceptBtn) return;
          btn.setAttribute('aria-expanded', 'false');
          btn.parentElement.classList.remove('open');
          if (menu) menu.dataset.open = 'false';
        });
      };

      dropdowns.forEach(({ btn, menu }) => {
        if (!menu) return;
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          const isOpen = btn.getAttribute('aria-expanded') === 'true';
          if (isOpen) {
            closeAll();
          } else {
            closeAll(btn);
            btn.setAttribute('aria-expanded', 'true');
            btn.parentElement.classList.add('open');
            menu.dataset.open = 'true';
            (menu.querySelector('a') || menu).focus();
          }
        });

        btn.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') {
            closeAll();
            btn.focus();
          }
        });
      });

      document.addEventListener('click', (e) => {
        if (!e.target.closest('.dropdown')) closeAll();
      });

      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closeAll();
      });
    })();
  </script>
</body>
</html>
