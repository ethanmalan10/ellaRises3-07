<main class="container main-content" style="max-width:1100px; margin-top:2.5rem;">
  <% 
    const _progressStage = (typeof progressStage !== 'undefined' && progressStage) ? progressStage : 'Bronze';
    const _progressTarget = (typeof progressTarget !== 'undefined' && progressTarget) ? progressTarget : 5;
    const _attendanceCount = (typeof attendanceCount !== 'undefined' && attendanceCount) ? attendanceCount : 0;
    const _progressPercent = (typeof progressPercent !== 'undefined' && progressPercent !== null)
      ? progressPercent
      : Math.min(100, Math.round((_attendanceCount / _progressTarget) * 100));
    const _currentMedal = (typeof navMedal !== 'undefined' && navMedal) ? navMedal : '';
    const _nextMedal = (typeof navMedalNext !== 'undefined' && navMedalNext)
      ? navMedalNext
      : (_progressStage === 'Gold'
          ? 'ðŸ¥‡'
          : (_progressStage === 'Silver' ? 'ðŸ¥ˆ' : 'ðŸ¥‰'));
  %>
  <% const isAuthed = !!currentUser; const regSet = new Set((registeredEventIds || []).map(Number)); function fmtDate(d){ return d ? new Date(d).toLocaleString('en-US', { dateStyle:'medium', timeStyle:'short' }) : ''; } %>

  <!-- Hero Card -->
  <section style="margin:0 0 2.25rem 0; width:82vw; position:relative; left:48%; transform:translateX(-50%);">
    <div style="
      position:relative;
      width:100%;
      height:180px;
      border-radius:16px;
      overflow:hidden;
      background:url('/images/office.jpeg') center 50%/cover no-repeat;
      display:flex;
      align-items:center;
      padding:24px 28px;
      box-shadow:0 12px 30px rgba(0,0,0,0.12);
    ">
      <div style="
        position:absolute;
        inset:0;
        background:linear-gradient(90deg, rgba(255,255,255,0.7) 0%, rgba(255,255,255,0.25) 25%, rgba(255,255,255,0) 45%);
      "></div>
      <h1 style="
        position:relative;
        margin:0;
        font-family:var(--font-serif);
        font-size:2.4rem;
        color:var(--charcoal);
        letter-spacing:0.5px;
      ">
        Events
      </h1>
    </div>
  </section>

  <hr style="border:0; border-top:2px solid rgba(58,63,59,0.15); margin:0 0 1.35rem 0;">

  <div style="background:var(--cream); border-radius:14px; padding:18px; text-align:center; margin:0 0 1.35rem 0; color:var(--charcoal); box-shadow:0 8px 18px rgba(0,0,0,0.06);">
    <h2 style="margin:0 0 .35rem 0; font-family:var(--font-serif); font-size:1.6rem; font-weight:700;">
      Come join us on our next adventure!
    </h2>
    <p style="margin:0; font-size:1rem; color:#4b5563;">
      We hold STEM, ART, & tour events! Everyone is invited. Create an account to RSVP!
    </p>
  </div>

  <!-- Attendance Progress (users only) -->
  <% if (isAuthed && !(currentUser && (currentUser.role === 'admin' || currentUser.role === 'manager'))) { %>
    <section class="container" style="margin:0 auto 1.25rem auto;">
      <div style="background:#f5efe3; border-radius:14px; padding:16px; box-shadow:0 6px 14px rgba(0,0,0,0.06);">
        <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px; margin-bottom:8px;">
          <div style="font-weight:700; color:var(--charcoal); display:flex; align-items:center; gap:8px;">
            <span>Progress: <%= _progressStage %> (goal: <%= _progressTarget %> events)</span>
            <% if (_currentMedal) { %>
              <span aria-label="Current status" title="Current status" style="font-size:1.05rem; line-height:1;"><%= _currentMedal %></span>
            <% } %>
          </div>
          <div style="color:var(--charcoal); opacity:0.8;">Attended: <%= _attendanceCount %></div>
        </div>
        <div style="position:relative; width:100%; height:14px; background:#e7dcc9; border-radius:999px; overflow:hidden; border:1px solid rgba(0,0,0,0.08);">
          <div style="height:100%; width:<%= Math.min(100, _progressPercent) %>%; background:var(--sage); border-radius:999px; position:relative;"></div>
          <% if (_nextMedal) { %>
            <span style="position:absolute; right:6px; top:50%; transform:translateY(-50%); font-size:1.1rem;"><%= _nextMedal %></span>
          <% } %>
        </div>
      </div>
    </section>
  <% } %>

  <hr style="border:0; border-top:2px solid rgba(58,63,59,0.15); margin:0 0 1.25rem 0;">

  <!-- Messages -->
  <% if (message) { %>
    <% let msgText = message;
       if (message === 'registered') msgText = 'RSVP confirmed.';
       else if (message === 'already') msgText = 'You are already registered for this event.';
       else if (message === 'created') msgText = 'Event created.';
       else if (message === 'updated') msgText = 'Event updated.';
       else if (message === 'deleted') msgText = 'Event deleted.';
    %>
    <div style="background:#e8faef; border:1px solid #9bd3b3; color:#205e37; padding:12px 16px; border-radius:10px; margin-bottom:1rem;">
      <%= msgText %>
    </div>
  <% } %>
  <% if (error) { %>
    <% let errText = error;
       if (error === 'bad-event') errText = 'Invalid event.';
       else if (error === 'noparticipant') errText = 'No participant record found for your username/email.';
       else if (error === 'rsvp') errText = 'Could not RSVP. Please try again.';
       else if (error === 'delete') errText = 'Could not delete event.';
       else if (error === 'notfound') errText = 'Event not found.';
    %>
    <div style="background:#ffe1e1; border:1px solid #dd9a9a; color:#7a2e2e; padding:12px 16px; border-radius:10px; margin-bottom:1rem;">
      <%= errText %>
    </div>
  <% } %>

  <!-- Upcoming events -->
  <section style="margin-bottom:2rem;">
    <div style="display:flex; justify-content:space-between; align-items:flex-end; gap:16px; flex-wrap:wrap; margin-bottom:1.4rem;">
      <div>
        <h3 style="margin:0 0 .5rem 0; font-size:1.5rem;">Upcoming</h3>
        <div>
          <input id="upcoming-search" type="search" placeholder="Quick search upcoming events..." style="width:100%; max-width:460px; padding:10px 12px; border-radius:10px; border:1px solid #d1d5db;">
        </div>
      </div>
      <% if (typeof isManager !== 'undefined' && isManager) { %>
        <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
          <a href="/events/stats" class="btn-cream" style="padding:12px 16px; border-radius:10px; text-decoration:none;">Event Stats</a>
          <a href="/events/past" class="btn-cream" style="padding:12px 16px; border-radius:10px; text-decoration:none;">View Past Events</a>
          <a href="/events/new" class="btn-cream" style="padding:12px 16px; border-radius:10px; text-decoration:none;">Create Event</a>
          <a href="/event-templates" class="btn-cream" style="padding:12px 16px; border-radius:10px; text-decoration:none;">Manage Event Templates</a>
        </div>
      <% } %>
    </div>
    <% if (!upcomingEvents || upcomingEvents.length === 0) { %>
      <p style="color:#6b7280;">No upcoming events yet.</p>
    <% } else { %>
      <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(320px, 1fr)); gap:16px; margin-top:12px;">
        <% upcomingEvents.forEach((ev, idx) => { %>
          <% const searchBlob = [(ev.eventname||''),(ev.eventdescription||''),(ev.eventlocation||''),(fmtDate(ev.eventdatetimestart)||''),(fmtDate(ev.eventdatetimeend)||'')].join(' ').toLowerCase(); %>
          <div class="card upcoming-card" data-search="<%= searchBlob %>" style="padding:16px; border-radius:14px; border:1px solid #e5e7eb; box-shadow:0 10px 30px rgba(0,0,0,0.04);">
            <div style="display:flex; justify-content:space-between; gap:10px; align-items:flex-start;">
              <div>
                <h4 style="margin:0 0 .3rem 0; font-size:1.15rem; color:var(--charcoal);"><%= ev.eventname %></h4>
                <p style="margin:0; color:#4b5563;"><%= ev.eventdescription %></p>
              </div>
              <% if (idx === 0) { %>
                <span style="background: var(--pink-soft); color: #3a3f3b; padding:4px 10px; border-radius:10px; border:2px solid #f7c948; font-size:0.9rem; font-weight:700;">Recommended for You!</span>
              <% } %>
              <% if (typeof isManager !== 'undefined' && isManager) { %>
                <span style="background:#eef2ff; color:#3730a3; padding:4px 8px; border-radius:8px; font-size:.8rem;">Manager</span>
              <% } %>
            </div>

            <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(160px,1fr)); gap:8px; margin-top:12px; color:#374151; font-size:.95rem;">
              <div><strong>Date</strong><br><%= fmtDate(ev.eventdatetimestart) %></div>
              <div><strong>Ends</strong><br><%= fmtDate(ev.eventdatetimeend) %></div>
              <div><strong>Location</strong><br><%= ev.eventlocation || 'TBD' %></div>
              <div><strong>Capacity</strong><br><%= ev.eventcapacity || 'â€”' %></div>
              <div><strong>Registered</strong><br><%= ev.registrations_count %></div>
            </div>

            <div style="display:flex; flex-wrap:wrap; gap:10px; margin-top:14px;">
              <% if (isAuthed) { %>
                <% if (regSet.has(Number(ev.eventoccurrenceid))) { %>
                  <form method="POST" action="/events/<%= ev.eventoccurrenceid %>/unrsvp">
                    <button type="submit" class="btn-outline" style="padding:10px 14px; border-radius:10px; border:1px solid #dc2626; color:#dc2626;">Cancel RSVP</button>
                  </form>
                <% } else { %>
                <form method="POST" action="/events/<%= ev.eventoccurrenceid %>/rsvp">
                  <button type="submit" class="btn-login-home" style="padding:10px 14px; border-radius:10px;">RSVP</button>
                </form>
                <% } %>
              <% } else { %>
                <a href="/login" class="btn-cream" style="padding:10px 14px; border-radius:10px; text-decoration:none;">Login to RSVP</a>
              <% } %>

              <% if (typeof isManager !== 'undefined' && isManager) { %>
                <a href="/events/<%= ev.eventoccurrenceid %>/edit" class="btn-cream" style="padding:10px 14px; border-radius:10px; text-decoration:none;">Edit</a>
                <form method="POST" action="/events/<%= ev.eventoccurrenceid %>/delete" onsubmit="return confirm('Delete this event?');">
                  <button type="submit" class="btn-outline" style="padding:10px 14px; border-radius:10px; border:1px solid #dc2626; color:#dc2626;">Delete</button>
                </form>
                <a href="/events/<%= ev.eventoccurrenceid %>/attendees" class="btn-cream" style="padding:10px 14px; border-radius:10px; text-decoration:none;">View Attendees</a>
              <% } %>
            </div>
          </div>
        <% }) %>
      </div>
    <% } %>
  </section>

</main>

<script>
  (() => {
    const input = document.getElementById('upcoming-search');
    const cards = Array.from(document.querySelectorAll('.upcoming-card'));
    if (!input || cards.length === 0) return;
    const run = () => {
      const q = (input.value || '').trim().toLowerCase();
      cards.forEach(c => {
        const match = !q || (c.dataset.search || '').includes(q);
        c.style.display = match ? '' : 'none';
      });
    };
    input.addEventListener('input', run);
  })();
</script>
