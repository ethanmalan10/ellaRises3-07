<main class="container main-content" style="max-width:1100px; margin-top:2.5rem;">
  <% function fmtDate(d){ return d ? new Date(d).toLocaleString('en-US', { dateStyle:'medium', timeStyle:'short' }) : ''; } %>
  <% const pag = pagination || { page:1, pageSize:(events || []).length || 50, total:(pagination && pagination.total) || (events ? events.length : 0), totalPages:1, hasPrev:false, hasNext:false }; %>

  <header style="display:flex; justify-content:space-between; align-items:center; gap:1rem; margin-bottom:1.25rem; flex-wrap:wrap;">
    <div>
      <h1 style="margin:0; font-family:var(--font-serif); color:var(--charcoal);">Past Events</h1>
      <p style="margin:.3rem 0 0 0; color:#4b5563;">Browse all past events. Use quick or advanced search to filter.</p>
    </div>
    <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
      <input id="past-search-live" type="text" placeholder="Quick search..." style="padding:10px 12px; border-radius:10px; border:1px solid #d1d5db; min-width:220px;">
      <a href="/events" class="btn-cream" style="padding:12px 16px; border-radius:10px; text-decoration:none;">Back to Events</a>
    </div>
  </header>

  <section style="padding:16px; border:1px solid #e5e7eb; border-radius:16px; background:#f8fafc; margin-bottom:1rem;">
    <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(220px,1fr)); gap:12px; align-items:end;">
      <div>
        <label style="font-weight:600; display:block; margin-bottom:.35rem;">Event Name</label>
        <input id="past-name" type="text" placeholder="e.g., robotics" style="width:90%; padding:10px; border-radius:10px; border:1px solid #d1d5db;">
      </div>
      <div>
        <label style="font-weight:600; display:block; margin-bottom:.35rem;">Location</label>
        <input id="past-location" type="text" placeholder="e.g., library" style="width:90%; padding:10px; border-radius:10px; border:1px solid #d1d5db;">
      </div>
      <div>
        <label style="font-weight:600; display:block; margin-bottom:.35rem;">Ended On/After</label>
        <input id="past-from" type="date" style="width:90%; padding:10px; border-radius:10px; border:1px solid #d1d5db;">
      </div>
      <div>
        <label style="font-weight:600; display:block; margin-bottom:.35rem;">Ended On/Before</label>
        <input id="past-to" type="date" style="width:90%; padding:10px; border-radius:10px; border:1px solid #d1d5db;">
      </div>
      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <button type="button" id="past-apply" class="btn-gradient" style="padding:12px 16px; border-radius:12px; min-width:110px;">Apply</button>
        <button type="button" id="past-clear" class="btn-cream" style="padding:12px 16px; border-radius:10px;">Clear</button>
      </div>
    </div>
  </section>

  <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap; margin-bottom:12px;">
    <div style="color:#4b5563;">Showing <%= Math.min((pag.page - 1) * pag.pageSize + 1, pag.total || 0) %>–<%= Math.min(pag.page * pag.pageSize, pag.total || 0) %> of <%= pag.total || 0 %></div>
    <form method="GET" style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
      <input type="hidden" name="page" value="<%= pag.page %>">
      <label style="display:flex; align-items:center; gap:6px;">
        <span style="color:#4b5563;">Per page</span>
        <select name="pageSize" onchange="this.form.page.value=1; this.form.submit();" style="padding:8px 10px; border-radius:10px; border:1px solid #d1d5db;">
          <% (pageSizeOptions || [25,50,75,100]).forEach(size => { %>
            <option value="<%= size %>" <%= size === pag.pageSize ? 'selected' : '' %>><%= size %></option>
          <% }) %>
        </select>
      </label>
      <div style="display:flex; gap:8px; flex-wrap:wrap;">
        <button type="submit" class="btn-cream" style="padding:8px 12px; border-radius:10px;" <%= pag.page > 1 ? '' : 'disabled' %> onclick="this.form.page.value=1;"><< Start</button>
        <button type="submit" class="btn-cream" style="padding:8px 12px; border-radius:10px;" <%= pag.hasPrev ? '' : 'disabled' %> onclick="this.form.page.value=<%= Math.max(1, pag.page - 1) %>;">&lt; Back</button>
        <button type="submit" class="btn-cream" style="padding:8px 12px; border-radius:10px;" <%= pag.hasNext ? '' : 'disabled' %> onclick="this.form.page.value=<%= Math.min(pag.totalPages, pag.page + 1) %>;">Next &gt;</button>
        <button type="submit" class="btn-cream" style="padding:8px 12px; border-radius:10px;" <%= pag.page < pag.totalPages ? '' : 'disabled' %> onclick="this.form.page.value=<%= pag.totalPages %>;">End >></button>
      </div>
    </form>
  </div>

  <% if (events && events.length > 0) { %>
    <div id="past-grid" style="display:grid; grid-template-columns:repeat(auto-fit, minmax(320px, 1fr)); gap:16px;">
      <% events.forEach(ev => {
           const start = ev.eventdatetimestart ? new Date(ev.eventdatetimestart) : null;
           const monthName = start ? start.toLocaleString('en-US', { month: 'long' }).toLowerCase() : '';
           const dayNum = start ? String(start.getDate()) : '';
           const loc = (ev.eventlocation || '').toLowerCase();
           const desc = (ev.eventdescription || '').toLowerCase();
           const name = ev.eventname.toLowerCase();
           const endIso = ev.eventdatetimeend ? new Date(ev.eventdatetimeend).toISOString() : '';
           const hasSurveys = Number(ev.survey_count || 0) > 0;
           const hasTemplateSurveys = Number(ev.template_survey_count || 0) > 0;
           const avgSat = hasSurveys && Number.isFinite(Number(ev.avg_satisfaction))
              ? Number(ev.avg_satisfaction).toFixed(2)
              : hasTemplateSurveys && Number.isFinite(Number(ev.template_avg_satisfaction))
                ? Number(ev.template_avg_satisfaction).toFixed(2)
                : '—';
           const avgOverall = hasSurveys && Number.isFinite(Number(ev.avg_overall))
              ? Number(ev.avg_overall).toFixed(2)
              : hasTemplateSurveys && Number.isFinite(Number(ev.template_avg_overall))
                ? Number(ev.template_avg_overall).toFixed(2)
                : '—';
           const surveyN = hasSurveys ? (ev.survey_count || 0) : (hasTemplateSurveys ? ev.template_survey_count || 0 : 0);
         %>
        <div
          class="card past-card"
          data-name="<%= name %>"
          data-desc="<%= desc %>"
          data-month="<%= monthName %>"
          data-day="<%= dayNum %>"
          data-loc="<%= loc %>"
          data-end="<%= endIso %>"
          style="padding:16px; border-radius:14px; border:1px solid #e5e7eb; box-shadow:0 10px 30px rgba(0,0,0,0.04); background:#f9fafb;"
        >
          <div style="display:flex; justify-content:space-between; gap:10px; align-items:flex-start;">
            <div>
              <h4 style="margin:0 0 .3rem 0; font-size:1.1rem; color:var(--charcoal);"><%= ev.eventname %></h4>
              <p style="margin:0; color:#4b5563;"><%= ev.eventdescription %></p>
            </div>
            <div style="display:flex; gap:6px; align-items:center; flex-wrap:wrap;">
              <% if (ev.eventtypename) { %>
                <span style="background:#eef2ff; color:#3730a3; padding:4px 8px; border-radius:8px; font-size:.8rem;"><%= ev.eventtypename %></span>
              <% } %>
              <span style="background:#fee2e2; color:#991b1b; padding:4px 8px; border-radius:8px; font-size:.8rem;">Past</span>
            </div>
          </div>

          <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(160px,1fr)); gap:8px; margin-top:12px; color:#374151; font-size:.95rem;">
            <div><strong>Date</strong><br><%= fmtDate(ev.eventdatetimestart) %></div>
            <div><strong>Ended</strong><br><%= fmtDate(ev.eventdatetimeend) %></div>
            <div><strong>Location</strong><br><%= ev.eventlocation || 'TBD' %></div>
            <div><strong>Capacity</strong><br><%= ev.eventcapacity || '—' %></div>
            <div><strong>Registered</strong><br><%= ev.registrations_count %></div>
            <div><strong>Avg Satisfaction</strong><br><%= avgSat %> <span style="color:#6b7280;">(n=<%= surveyN %>)</span></div>
            <div><strong>Avg Overall</strong><br><%= avgOverall %></div>
          </div>

          <div style="display:flex; flex-wrap:wrap; gap:10px; margin-top:14px;">
            <a href="/events/<%= ev.eventoccurrenceid %>/edit" class="btn-cream" style="padding:10px 14px; border-radius:10px; text-decoration:none;">Edit</a>
            <form method="POST" action="/events/<%= ev.eventoccurrenceid %>/delete" onsubmit="return confirm('Delete this event?');">
              <button type="submit" class="btn-outline" style="padding:10px 14px; border-radius:10px; border:1px solid #dc2626; color:#dc2626;">Delete</button>
            </form>
          </div>
        </div>
      <% }) %>
    </div>
    <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap; margin-top:14px;">
      <div style="color:#4b5563;">Showing <%= Math.min((pag.page - 1) * pag.pageSize + 1, pag.total || 0) %>–<%= Math.min(pag.page * pag.pageSize, pag.total || 0) %> of <%= pag.total || 0 %></div>
      <form method="GET" style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
        <input type="hidden" name="page" value="<%= pag.page %>">
        <label style="display:flex; align-items:center; gap:6px;">
          <span style="color:#4b5563;">Per page</span>
          <select name="pageSize" onchange="this.form.page.value=1; this.form.submit();" style="padding:8px 10px; border-radius:10px; border:1px solid #d1d5db;">
            <% (pageSizeOptions || [25,50,75,100]).forEach(size => { %>
              <option value="<%= size %>" <%= size === pag.pageSize ? 'selected' : '' %>><%= size %></option>
            <% }) %>
          </select>
        </label>
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <button type="submit" class="btn-cream" style="padding:8px 12px; border-radius:10px;" <%= pag.page > 1 ? '' : 'disabled' %> onclick="this.form.page.value=1;"><< Start</button>
          <button type="submit" class="btn-cream" style="padding:8px 12px; border-radius:10px;" <%= pag.hasPrev ? '' : 'disabled' %> onclick="this.form.page.value=<%= Math.max(1, pag.page - 1) %>;">&lt; Back</button>
          <button type="submit" class="btn-cream" style="padding:8px 12px; border-radius:10px;" <%= pag.hasNext ? '' : 'disabled' %> onclick="this.form.page.value=<%= Math.min(pag.totalPages, pag.page + 1) %>;">Next &gt;</button>
          <button type="submit" class="btn-cream" style="padding:8px 12px; border-radius:10px;" <%= pag.page < pag.totalPages ? '' : 'disabled' %> onclick="this.form.page.value=<%= pag.totalPages %>;">End >></button>
        </div>
      </form>
    </div>
  <% } else { %>
    <p style="color:#6b7280;">No past events found.</p>
  <% } %>
</main>

<script>
  (() => {
    const cards = Array.from(document.querySelectorAll('.past-card'));
    if (cards.length === 0) return;

    const quick = document.getElementById('past-search-live');
    const nameInput = document.getElementById('past-name');
    const locInput = document.getElementById('past-location');
    const fromInput = document.getElementById('past-from');
    const toInput = document.getElementById('past-to');
    const applyBtn = document.getElementById('past-apply');
    const clearBtn = document.getElementById('past-clear');

    const filter = () => {
      const q = (quick?.value || '').trim().toLowerCase();
      const nameQ = (nameInput?.value || '').trim().toLowerCase();
      const locQ = (locInput?.value || '').trim().toLowerCase();
      const fromQ = fromInput?.value ? new Date(fromInput.value) : null;
      const toQ = toInput?.value ? new Date(toInput.value) : null;

      cards.forEach(c => {
        const name = c.dataset.name || '';
        const desc = c.dataset.desc || '';
        const month = c.dataset.month || '';
        const day = c.dataset.day || '';
        const loc = c.dataset.loc || '';
        const endIso = c.dataset.end || '';
        const endDate = endIso ? new Date(endIso) : null;

        const matchesQuick =
          !q ||
          name.includes(q) ||
          desc.includes(q) ||
          month.includes(q) ||
          day.includes(q) ||
          loc.includes(q);

        const matchesName = !nameQ || name.includes(nameQ);
        const matchesLoc = !locQ || loc.includes(locQ);
        const matchesFrom = !fromQ || (endDate && endDate >= fromQ);
        const matchesTo = !toQ || (endDate && endDate <= toQ);

        const show = matchesQuick && matchesName && matchesLoc && matchesFrom && matchesTo;
        c.style.display = show ? '' : 'none';
      });
    };

    quick?.addEventListener('input', filter);
    applyBtn?.addEventListener('click', filter);
    [nameInput, locInput, fromInput, toInput].forEach(el => {
      el?.addEventListener('keypress', e => {
        if (e.key === 'Enter') {
          e.preventDefault();
          filter();
        }
      });
    });
    clearBtn?.addEventListener('click', () => {
      [quick, nameInput, locInput, fromInput, toInput].forEach(el => {
        if (el) el.value = '';
      });
      filter();
    });

    filter();
  })();

  (function(){
    const btn = document.createElement('button');
    btn.id = 'jump-to-top-past-events';
    btn.type = 'button';
    btn.textContent = 'Jump to Top';
    btn.style.cssText = 'position:fixed; right:20px; bottom:20px; padding:10px 14px; border-radius:10px; border:none; background:#2e2f2e; color:#fff; cursor:pointer; display:none; box-shadow:0 6px 18px rgba(0,0,0,0.18); z-index:999;';
    btn.addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));
    document.body.appendChild(btn);
    window.addEventListener('scroll', () => {
      btn.style.display = window.scrollY > 240 ? 'block' : 'none';
    });
  })();
</script>
