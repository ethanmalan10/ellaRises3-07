<section class="content">
<% const pag = pagination || { page:1, pageSize: (users || []).length, total:(users || []).length, totalPages:1, hasPrev:false, hasNext:false }; %>
<div class="page-header" style="display:flex; justify-content:space-between; align-items:center; gap:1rem; flex-wrap:wrap; margin-bottom:1rem;">
  <div>
    <h1 style="margin:0; font-family:var(--font-serif); color:var(--charcoal);">All Users</h1>
    <p class="muted" style="margin:.3rem 0 0 0;">Manager view of users and their linked participants.</p>
  </div>
  <div style="display:flex; gap:10px; flex-wrap:wrap;">
    <a class="btn-login-home" href="/admin/users/add" style="padding:10px 16px; border-radius:10px; text-decoration:none; box-shadow:0 6px 14px rgba(0,0,0,0.08);">Add User</a>
    <a class="btn-cream" href="/" style="padding:10px 14px; border-radius:10px; text-decoration:none;">Back to Home</a>
  </div>
</div>

<form style="margin:6px 0 12px 0; display:flex; gap:8px; flex-wrap:wrap;" onsubmit="return false;">
  <label for="user-search" class="sr-only">Search users</label>
  <input id="user-search" type="text" placeholder="Quick search users..." style="width:100%; max-width:320px; padding:10px 12px; border:1px solid #d1d5db; border-radius:10px;">
  <button id="user-search-btn" class="btn-cream" style="padding:10px 14px; border-radius:10px;">Search</button>
  <button id="user-clear-btn" class="btn-outline" style="padding:10px 14px; border-radius:10px;">Clear</button>
</form>
<div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap; margin-bottom:10px;">
  <div style="color:#4b5563;">Showing <%= Math.min((pag.page - 1) * pag.pageSize + 1, pag.total || 0) %>–<%= Math.min(pag.page * pag.pageSize, pag.total || 0) %> of <%= pag.total || 0 %></div>
  <form method="GET" style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
    <input type="hidden" name="page" value="<%= pag.page %>">
    <label style="display:flex; align-items:center; gap:6px;">
      <span style="color:#4b5563;">Per page</span>
      <select name="pageSize" onchange="this.form.page.value=1; this.form.submit();" style="padding:8px 10px; border-radius:10px; border:1px solid #d1d5db;">
        <% (pageSizeOptions || [25,50,75,100]).forEach(size => { %>
          <option value="<%= size %>" <%= size === pag.pageSize ? 'selected' : '' %>><%= size %></option>
        <% }) %>
      </select>
    </label>
    <div style="display:flex; gap:8px; flex-wrap:wrap;">
      <button type="submit" class="btn-cream" style="padding:8px 12px; border-radius:10px;" <%= pag.page > 1 ? '' : 'disabled' %> onclick="this.form.page.value=1;"><< Start</button>
      <button type="submit" class="btn-cream" style="padding:8px 12px; border-radius:10px;" <%= pag.hasPrev ? '' : 'disabled' %> onclick="this.form.page.value=<%= Math.max(1, pag.page - 1) %>;">&lt; Back</button>
      <button type="submit" class="btn-cream" style="padding:8px 12px; border-radius:10px;" <%= pag.hasNext ? '' : 'disabled' %> onclick="this.form.page.value=<%= Math.min(pag.totalPages, pag.page + 1) %>;">Next &gt;</button>
      <button type="submit" class="btn-cream" style="padding:8px 12px; border-radius:10px;" <%= pag.page < pag.totalPages ? '' : 'disabled' %> onclick="this.form.page.value=<%= pag.totalPages %>;">End >></button>
    </div>
  </form>
</div>

  <% if (!users || users.length === 0) { %>
    <p style="color:#6b7280;">No users found.</p>
  <% } else { %>
    <div class="card" style="padding:16px; border-radius:12px; border:1px solid #e5e7eb;">
      <table id="users-table" style="width:100%; border-collapse:collapse;">
        <caption style="text-align:left; padding:10px; font-weight:600;">All users</caption>
        <thead>
          <tr style="text-align:left; border-bottom:1px solid #e5e7eb;">
            <th scope="col" style="padding:10px;">User ID</th>
            <th scope="col" style="padding:10px;">Username</th>
            <th scope="col" style="padding:10px;">Role</th>
            <th scope="col" style="padding:10px;">Participant</th>
            <th scope="col" style="padding:10px;">City / State</th>
            <th scope="col" style="padding:10px;">Email</th>
            <th scope="col" style="padding:10px;">Actions</th>
          </tr>
        </thead>
        <tbody>
          <% users.forEach(u => { %>
            <tr class="user-row" style="border-bottom:1px solid #f3f4f6;">
              <td style="padding:10px;"><%= u.userid %></td>
              <td style="padding:10px; font-weight:600;"><%= u.username %></td>
              <td style="padding:10px; text-transform:uppercase;"><%= u.level %></td>
              <td style="padding:10px;">
                <% if (u.participantid) { %>
                  <div style="font-weight:700;"><%= u.participantfirstname %> <%= u.participantlastname %></div>
                  <div class="muted">ID: <%= u.participantid %></div>
                <% } else { %>
                  <span class="muted">Unlinked</span>
                <% } %>
              </td>
              <td style="padding:10px;"><%= [u.participantcity, u.participantstate].filter(Boolean).join(' ') %></td>
              <td style="padding:10px;"><%= u.participantemail || '' %></td>
              <td style="padding:10px; display:flex; gap:6px; flex-wrap:wrap;">
                <a href="/admin/users/<%= u.userid %>/edit" class="btn-cream" style="padding:8px 12px; border-radius:8px; text-decoration:none;">Edit</a>
                <% const isSelf = currentUser && Number(currentUser.id) === Number(u.userid); %>
                <% if (isSelf) { %>
                  <button type="button" class="btn-outline" style="padding:8px 12px; border-radius:8px; border:1px solid #d1d5db; color:#6b7280; cursor:not-allowed;" disabled title="You cannot delete your own account">Delete</button>
                <% } else { %>
                  <form method="POST" action="/admin/users/<%= u.userid %>/delete" onsubmit="return confirm('Delete this user?');">
                    <button type="submit" class="btn-outline" style="padding:8px 12px; border-radius:8px; border:1px solid #dc2626; color:#dc2626;">Delete</button>
                  </form>
                <% } %>
              </td>
            </tr>
          <% }); %>
        </tbody>
      </table>
    </div>
    <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap; margin-top:12px;">
      <div style="color:#4b5563;">Showing <%= Math.min((pag.page - 1) * pag.pageSize + 1, pag.total || 0) %>–<%= Math.min(pag.page * pag.pageSize, pag.total || 0) %> of <%= pag.total || 0 %></div>
      <form method="GET" style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
        <input type="hidden" name="page" value="<%= pag.page %>">
        <label style="display:flex; align-items:center; gap:6px;">
          <span style="color:#4b5563;">Per page</span>
          <select name="pageSize" onchange="this.form.page.value=1; this.form.submit();" style="padding:8px 10px; border-radius:10px; border:1px solid #d1d5db;">
            <% (pageSizeOptions || [25,50,75,100]).forEach(size => { %>
              <option value="<%= size %>" <%= size === pag.pageSize ? 'selected' : '' %>><%= size %></option>
            <% }) %>
          </select>
        </label>
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <button type="submit" class="btn-cream" style="padding:8px 12px; border-radius:10px;" <%= pag.page > 1 ? '' : 'disabled' %> onclick="this.form.page.value=1;"><< Start</button>
          <button type="submit" class="btn-cream" style="padding:8px 12px; border-radius:10px;" <%= pag.hasPrev ? '' : 'disabled' %> onclick="this.form.page.value=<%= Math.max(1, pag.page - 1) %>;">&lt; Back</button>
          <button type="submit" class="btn-cream" style="padding:8px 12px; border-radius:10px;" <%= pag.hasNext ? '' : 'disabled' %> onclick="this.form.page.value=<%= Math.min(pag.totalPages, pag.page + 1) %>;">Next &gt;</button>
          <button type="submit" class="btn-cream" style="padding:8px 12px; border-radius:10px;" <%= pag.page < pag.totalPages ? '' : 'disabled' %> onclick="this.form.page.value=<%= pag.totalPages %>;">End >></button>
        </div>
      </form>
    </div>
  <% } %>
</section>

<script>
  (function(){
    const input = document.getElementById('user-search');
    const btn = document.getElementById('user-search-btn');
    const clearBtn = document.getElementById('user-clear-btn');
    const rows = Array.from(document.querySelectorAll('#users-table .user-row'));
    if (!input || !btn || !clearBtn || rows.length === 0) return;

    const storageKey = 'userSearch';
    const saved = sessionStorage.getItem(storageKey) || '';
    if (saved) input.value = saved;

    const runFilter = () => {
      const q = input.value.trim().toLowerCase();
      sessionStorage.setItem(storageKey, input.value.trim());
      rows.forEach(r => {
        const text = r.innerText.toLowerCase();
        r.style.display = q ? (text.includes(q) ? '' : 'none') : '';
      });
    };
    btn.addEventListener('click', (e) => { e.preventDefault(); runFilter(); });

    clearBtn.addEventListener('click', (e) => {
      e.preventDefault();
      input.value = '';
      sessionStorage.removeItem(storageKey);
      rows.forEach(r => r.style.display = '');
    });

    if (saved) runFilter();
  })();

  (function(){
    const btn = document.createElement('button');
    btn.id = 'jump-to-top-users';
    btn.type = 'button';
    btn.textContent = 'Jump to Top';
    btn.style.cssText = 'position:fixed; right:20px; bottom:20px; padding:10px 14px; border-radius:10px; border:none; background:#2e2f2e; color:#fff; cursor:pointer; display:none; box-shadow:0 6px 18px rgba(0,0,0,0.18); z-index:999;';
    btn.addEventListener('click', () => window.scrollTo({ top: 0, behavior: "smooth" }));
    document.body.appendChild(btn);
    window.addEventListener('scroll', () => {
      btn.style.display = window.scrollY > 240 ? 'block' : 'none';
    });
  })();
</script>
